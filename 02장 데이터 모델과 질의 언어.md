## 데이터 저장과 질의를 위한 다양한 범용 데이터 모델 기술

### 관계형 모델과 문서 모델
  - 오늘날 잘 알려진 관계형 SQL
    - 데이터는 관계로 구성되고 각 관계는 순서 없는 튜플(tuple) (SQL에서 로우(Row)) 모음이다.
    - 관계형 DB의 근원은 비지니스 데이터 처리, 즉 트랜잭션 처리( EX) 영업, 은행 업무, 항공 예약, 창고 보관)와 일괄처리 ( EX)고객 송장 작성, 급여 지불,보고)로 오늘날의 관점에서는 일상적으로 수행되는 일
    - 수년동안 데이터 저장과 질의를 위해 많은 접근 방식이 경쟁했다. EX) 네트워크 모델, 계층 모델
     <BR/>
  - NOSQL ( Not Only SQL )
    - 2010년대 관계형 모델의 우위를 뒤집으려는 최신 시도
    - 2009년 오픈소스,분산환경, 비관계형 데이터베이스 밋업(meetup)용 인기 트위터 해쉬태그였다.  
    - 관계형 모델에서 지원하지 않는 특수 질의 동작
    - 관계형 스키마의 제한에 대한 불만과 더욱 동적이고 표현력이 풍부한 데이터 모델에 대한 바람
     <BR/>
  #### 애플리케이션은 저마다 요구사항이 다르다. 
    한 사용 사례에 맞는 최적의 기술 선택은 또 다른 사용 사례에 맞는 최적의 선택과는 다를 수 있다.
  <BR/>
  
  - 객체 관계형 불일치
    - 임피던스 불일치 : 데이터를 관계형 테이블에 저장하려면 애플리케이션 코드와 DB 모델 객체(테이블,로우,칼럼) 사이에 거추장스러운 전환 계층이 필요하다. 이런 모델 사이의 분리를 일컫는다.
    -  액티브레코드(ActiveRecord)나 하이버네이트(Hibernate) 같은 관계형 매핑(ORM) 프레임워크는 전환 계층에 필요한 상용구 코드의 양은 줄지만 두 모델간의 차이는 완벽히 숨길 수 없다.
    -  이력서 같은 데이터 구조는 모든 내용을 갖추고 있는 문서라 JSON 표현에 매우 적합하다.(XML보다 휠씬 더 간단히 매력적이다.)
    -  일부 개발자는 JSON 모델이 애플리케이션 코드와 저장 계층 간 임피던스 불일치를 줄인다고 생각한다.
    <BR/>
  - 다대일 다대다 관계
    - ID나 텍스트 문자열의 저장 여부는 중복의 문제다. ID를 사용하는 경우 사람에게 의미 있는 정보는 한곳에 저장하고 그것을 참조하는 모든것은 ID를 사용한다.
    - 텍스트를 직접 저장한다면 그것을 사용하는 모든 레코드에서 사람을 의미하는 정보를 중복해서 저장하게 된다.
    - ID를 사용하는 장점으로는 ID 자체에는 아무런 의미가 없기 때문에 변경할 필요가 없다. 즉 식별 정보를 변경해도 ID는 동일하게 유지할 수 있다.
  - 네트워크 모델
    - 다양한 여러 DB 벤더가 네트워크 모델을 구현했고 코다실 모델이라고 부른다. 코다실 모델은 계층 모델을 일반화한다.
    - 네트워크 모델에서 레코드 간 연결은 외래 키보다는 프로그래밍 언어의 포인터와 더 비슷하다.
    - 접근 경로 : 레코드에 접근하는 유일한 방법은 최상위 레코드(root Record)에서 부터 연속된 연결 경로를 따르는 방법이다.
    - 만약 레코드가 다중 부모( 다른 레코드에서 다중으로 유입된 포인터)를 가진다면 애플리케이션 코드는 다양한 관계를 모두 추적해야 한다.
  - 관계형 모델
    - 모든 데이터를 배치하는 것
    - 접근 경로를 질의 최적화기가 자동으로 만든다. (질의 최적화기 : 질의의 어느 부분을 어떤 순서로 실행할지를 결정하고 사용할 색인을 자동으로 결정한다.)
    - 질의 최적화기를 한번 만들면 DB를 사용하는 모든 애플리케이션이 혜택을 받을 수 있다는 점이다.
   <BR/>
   
  - 문서 DB와의 비교
    - 문서 DB는 별도 테이블이 아닌 상위 레코드 내에서 중첩된 레코드를 저장한다.
    - 다대일과 대대다 관계를 표현시에 관계형 DB와 같이 고유한 식별자로 참조한다.(관계형 DB: 외래키, 문서 DB : 문서참조)
  - 관계형 DB와 오늘날 문서 DB
    - 문서 데이터 모델을 선호하는 이유는 스키마 유연성, 지역성에 기인한 더 나은 성능과 더불어 일부 애플리케이션의 경우 애플리케이션에서 사용하는 데이터 구조와 더 가깝기 때문이다.
    - 관계형 모델은 조인, 다대일, 다대다 관계를 더 잘 지원함으로써 문서 데이터 모델에 대항한다.
<BR/>

#### 그렇다면 어떤 데이터 모델이 애플리케이션 코드를 더 간단하게 할까?
  - 애플리케이션에서 데이터가 문서와 비슷한 구조( 일대다 관계 트리로 보통 한번에 전체 트리를 적재) 시에는 문서 모델을 사용한다.
  - 문서 모델에는 제한이 있다. <BR/>
  EX) 문서 내 중첩 항목을 바로 참조할 수는 없다. 문서가 너무 깊게 중첩되지 않으면 일반적으로 문제가 되지 않는다.
  - 문서 모델에서의 스키마 유연성
    - 대부분의 문서 DB와 관계형 DB에서 지원하는 JSON은 문서의 데이터에 어떤 스키마를 강요하지 않는다.
    - 문서 DB는 종종 스키마리스(Schemaless)로 불리지만 이는 오해의 소지가 있다. 데이터를 읽는 코드는 보통 구조의 유형을 어느정도 가정한다.
    - 읽기 스키마(schema-on-read) : 데이터 구조는 암묵적이고 데이터를 읽을 때만 해석된다.
    - 읽기 스키마는 프로그래밍 언어에서 동적(런타입) 타입 확인과 유사하고 쓰기 쓰키마는 정적(컴파일 타임) 타입 확인과 비슷하다.
    - DB에서 스키마 강제는 논쟁의 여지가 있는 주제이며 일반적으로 옳고 그린 정답은 없다.
  #### Q. 현재 하나의 필드에 사용자의 전체 이름을 저장하고 있지만 성과 이름을 분리해서 저장하고 싶다면? (접근 방식의 차이)
    - 문서 DB에서는 새로운 필드를 가진 새로운 문서를 작성하기 시작하고 애플리케이션에서는 예전 문서를 읽은 경우를 처리하는 코드만 있으면 된다.
      ```JAVA
      if(user && user.name && !user.first_name) {
      // 2013년 12월 8일 이전에 쓴 문서는 first_name이 없음
        user.first_name = user.name.split(" ")[0]
      ```
    - 정적 타입의 DB 스키마에서는 보통 다음과 깉이 마이그레이션(migration)을 수행한다.
      ``` JAVA
      ALTER TABLE users ADD COLUMN first_name text;
      UPDATE users SET first_name = split_part(name, ' ', 1); // PostgreSQL
      UPDATE users SET first_name = substring_index(name,' ',1); // MySQL
      ```  
    - 큰 테이블에서 update를 실행하면 모든 로우가 재작성될수 있기 때문에 어떤 DB는 오래 걸릴 수 있다.

#### 질의를 위한 데이터 지역성
  - 문서는 보통 JSON, XML로 부호화된 단일 연속 문자열(MongoDB, BSON)이나 JSON 또는 XML의 이진 변형으로 저장된다.
  - 웹 페이지 상에서 문서를 보여주는 동작처럼 애플리케이션이 자주 전체 문서에 접근해야할 때 저장소 지역성(storage locality)을 활용하면 성능이점이 있다.
  - 지역성의 이점은 한 번에 해당 문서의 많은 부분을 필요로 하는 경우에만 적용된다.
  - DB는 대개 문서의 작은 부분에만 접근해도 전체 문서를 적재해야 한다. 문서를 갱신시에도 보통 문제를 재작성 해야한다. (일반적으로 문서를 아주 작게 유지하면서 문서의 크기가 증가하는 쓰기를 피하라고 권장한다.)
  - 지역성을 위해 관련 데이터를 함께 그룹화하는 개념이 문서 모델에만 국한되지 않는다는 점이 중요하다.
  - EX) 구글 Spanner DB : 부모 테이블 내에서 (중첩되게) 테이블의 로우를 교차 배치되게끔 선언하는 스키마를 허용해 관계형 데이터 모델에서 지역성 특성을 동일하게 제공한다.
  - EX) 오라클 : 다중 테이블 색인 클러스터 테이블 기능을 사용해 동일한 특성을 제공한다.
  - EX) 빅데이블 데이터 모델의 칼럼패밀리(Column-Family) 개념(Casandra, HBase)이 지역성 관리와 유사한 목적이 있다.

#### 관계형 DB와 문서용 DB 통합
  - PostgreSQL 9.3 버전부터 ~ MYSQL 5.7 버전부터, IBM DB2는 10.5 버전부터 JSON 문서에 대해 비슷한 수준의 지원 기능을 제공한다.

### 데이터를 위한 질의 언어 
  일반적으로 많이 사용하는 프로그래밍 언어는 명령형 언어이다. 명령형 언어는 특정 순서를 특정 연산을 수행하게끔 컴퓨터에게 지시한다.<BR/>
  SQL이나 관계 대수 같은 선언형 질의 언어에서는 목표를 달성하기 위한 방법이 아니라 알고자 하는 데이터의 패턴, 즉 결과가 충족해야 하는 조건과 데이터를 어떻게 변환( EX) 정렬, 그룹화, 집계))할지를 정하면 된다.
  어떤 색인과 어떤 조인 함수를 사용할지, 질의의 다양한 부분을 어떤 순서로 실행할지를 결정하는 일은 DB 시스템의 질의 최적화기가 할 일이다.
#### 선언형 질의
  - 선언형 질의 언어의 장점은 DB에만 국한되지 않는다. 웹브라우저 환경 (선언형 접근 방식 / 명령형 접근 방식)
#### 맵리듀스 질의
  - 많은 컴퓨터에서 대량의 데이터를 처리하기 위한 프로그래밍 모델로 몽고DB, CouchDB를 포함한 일부 NOSQL 데이터 저장소는 제한된 형태의 맵리듀스를 지원한다. (읽기 전용 Read-Only 질의 수행시)
  - 맵리듀스는 선언형 질의와 완전한 명령형 질의의 중간 정도에 있다.
  - 맵리듀스는 map과 reduce 함수를 기반으로 한다.
  - 연계된 자바스크립트 함수 두 개를 신중하게 작성해야 한다. + 몽고 DB는 순수 함수여야 하는 제약사항이 존재하기에 집계 파이프라인(Aggregation pipeline)이라는 선언형 질의 언어 지원을 추가했다.
#### 그래프형 데이터 모델
  - 애플리케이션이 주로 일대다 관계(트리 구조 데이터)이거나 레코드 간 관계가 없다면 문서 모델이 적합하다.
  - 하지만 데이터에서 다대다 관계가 매우 일반적이라면 ? -> 일반적으로 관계형 데이터는 단순한 다대다 관계를 다룰 수 있다. 하지만 데이터 간 연결이 더 복잡해지면 ? -> 그래프로 데이터를 모델링하기 시작하는 편이 더 자연스럽다.
  - 그래는 두 유형의 객체로 이뤄진다. 정점 vertex 과 간선 edge
  - ex) 소셜 그래프(사람-사람관계), 웹그래프(웹페이지,다른웹페이지HTML링크),도로나 철도 네트워크(교차로-도로/철도선)
  - 단일 데이터 저장소에 완전히 다른 유형의 객체를 일관성 있게 저장할 수있는 강력한 방법을 제공한다.
##### 속성그래프
  - 고유한 식별자
  - 유출(Outgoing) 간선집합
  - 유입(Incoming) 간선집합
  - 속성 컬렉션(키-값 쌍)
##### 간선
  - 고유한 식별자
  - 간선이 시작하는 정점
  - 간선이 끝나는 정점
  - 두 정점 간 관계 유형을 설명하는 레이블
  - 속성 컬렉션(키-값 쌍)
